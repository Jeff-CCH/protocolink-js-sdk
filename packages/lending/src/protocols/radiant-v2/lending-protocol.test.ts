import { LendingProtocol } from './lending-protocol';
import * as common from '@protocolink/common';
import { expect } from 'chai';

describe('Test Radiant V2 LendingProtocol', function () {
  context('Test getPortfolio', function () {
    const testCases = [
      {
        chainId: common.ChainId.mainnet,
        account: '0xaF184b4cBc73A9Ca2F51c4a4d80eD67a2578E9F4',
        blockTag: 18797586,
        expected: {
          chainId: 1,
          protocolId: 'radiant-v2',
          marketId: 'mainnet',
          utilization: '0.97822902811306442548',
          healthRate: '1.06588844353662664751',
          netAPY: '-1.19664219493855548459',
          totalSupplyUSD: '11342075.4944172804881341603106315',
          totalBorrowUSD: '8649160.64068362879503470404861',
          supplies: [
            {
              token: {
                chainId: 1,
                address: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                decimals: 6,
                symbol: 'USDT',
                name: 'Tether USD',
              },
              price: '0.99961',
              balance: '2042222.619374',
              apy: '0.06265524668583752455',
              usageAsCollateralEnabled: true,
              ltv: '0.75',
              liquidationThreshold: '0.78',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '5831921.954657',
            },
            {
              token: {
                chainId: 1,
                address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                decimals: 6,
                symbol: 'USDC',
                name: 'USD Coin',
              },
              price: '1.00027726',
              balance: '2222.533477',
              apy: '0.05652398165619130639',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.83',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '7894657.691217',
            },
            {
              token: {
                chainId: 1,
                address: '0x0000000000000000000000000000000000000000',
                decimals: 18,
                symbol: 'ETH',
                name: 'Ethereum',
              },
              price: '2242.39893',
              balance: '1103.573542689366688272',
              apy: '0.09945981063749235836',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.83',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '8206.144884311207768305',
            },
            {
              token: {
                chainId: 1,
                address: '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',
                decimals: 8,
                symbol: 'WBTC',
                name: 'Wrapped BTC',
              },
              price: '42140.09169',
              balance: '44.04572006',
              apy: '0.00563326889771342122',
              usageAsCollateralEnabled: true,
              ltv: '0.73',
              liquidationThreshold: '0.78',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '934.88422103',
            },
            {
              token: {
                chainId: 1,
                address: '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0',
                decimals: 18,
                symbol: 'wstETH',
                name: 'Wrapped liquid staked Ether 2.0',
              },
              price: '2579.31314226',
              balance: '1925.888117004630721355',
              apy: '0.00591641734410512259',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.83',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '13441.57315134992665744',
            },
            {
              token: {
                chainId: 1,
                address: '0xae78736Cd615f374D3085123A210448E74Fc6393',
                decimals: 18,
                symbol: 'rETH',
                name: 'Rocket Pool ETH',
              },
              price: '2450.18252296',
              balance: '0.087686639817703145',
              apy: '0.00933862214704218952',
              usageAsCollateralEnabled: true,
              ltv: '0.75',
              liquidationThreshold: '0.8',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '2210.188081321430521736',
            },
          ],
          borrows: [
            {
              token: {
                chainId: 1,
                address: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                decimals: 6,
                symbol: 'USDT',
                name: 'Tether USD',
              },
              price: '0.99961',
              balances: ['2036566.319793'],
              apys: ['0.34885803310031651378'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '4743772.101778',
            },
            {
              token: {
                chainId: 1,
                address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                decimals: 6,
                symbol: 'USDC',
                name: 'USD Coin',
              },
              price: '1.00027726',
              balances: ['0'],
              apys: ['0.30895630613608824961'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '6451466.292218',
            },
            {
              token: {
                chainId: 1,
                address: '0x0000000000000000000000000000000000000000',
                decimals: 18,
                symbol: 'ETH',
                name: 'Ethereum',
              },
              price: '2242.39893',
              balances: ['2116.653363798114056777'],
              apys: ['0.58286757852021725784'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '6781.209342806900264987',
            },
            {
              token: {
                chainId: 1,
                address: '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',
                decimals: 8,
                symbol: 'WBTC',
                name: 'Wrapped BTC',
              },
              price: '42140.09169',
              balances: ['44.30477649'],
              apys: ['0.08556795486415211131'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '255.88862263',
            },
            {
              token: {
                chainId: 1,
                address: '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0',
                decimals: 18,
                symbol: 'wstETH',
                name: 'Wrapped liquid staked Ether 2.0',
              },
              price: '2579.31314226',
              balances: ['0'],
              apys: ['0.08352546390718506892'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '3954.606921120925819826',
            },
            {
              token: {
                chainId: 1,
                address: '0xae78736Cd615f374D3085123A210448E74Fc6393',
                decimals: 18,
                symbol: 'rETH',
                name: 'Rocket Pool ETH',
              },
              price: '2450.18252296',
              balances: ['0'],
              apys: ['0.1059438357261863594'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '816.842177473108670771',
            },
          ],
        },
      },
      {
        chainId: common.ChainId.arbitrum,
        account: '0xBf891E7eFCC98A8239385D3172bA10AD593c7886',
        blockTag: 160658642,
        expected: {
          chainId: 42161,
          protocolId: 'radiant-v2',
          marketId: 'arbitrum',
          utilization: '0.99482640662952741054',
          healthRate: '1.04721703882927822941',
          netAPY: '-0.29111736722085137435',
          totalSupplyUSD: '28931071.94611821305332002113083932',
          totalBorrowUSD: '22455171.44491027878871862817614778',
          supplies: [
            {
              token: {
                chainId: 42161,
                address: '0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f',
                decimals: 8,
                symbol: 'WBTC',
                name: 'Wrapped BTC',
              },
              price: '42230.4416495',
              balance: '99.14372699',
              apy: '0.00919880889510915271',
              usageAsCollateralEnabled: true,
              ltv: '0.7',
              liquidationThreshold: '0.75',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '1623.87981095',
            },
            {
              token: {
                chainId: 42161,
                address: '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9',
                decimals: 6,
                symbol: 'USDT',
                name: 'Tether USD',
              },
              price: '0.99993522',
              balance: '0',
              apy: '0.04577020387917572561',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '10456412.372008',
            },
            {
              token: {
                chainId: 42161,
                address: '0xFF970A61A04b1cA14834A43f5dE4533eBDDB5CC8',
                decimals: 6,
                symbol: 'USDC.e',
                name: 'USD Coin (Arb1)',
              },
              price: '1.00023692',
              balance: '0',
              apy: '0.0601275814876277881',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '40176603.062705',
            },
            {
              token: {
                chainId: 42161,
                address: '0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1',
                decimals: 18,
                symbol: 'DAI',
                name: 'Dai Stablecoin',
              },
              price: '1.00005605',
              balance: '356.025961434974232342',
              apy: '0.04044080289699676233',
              usageAsCollateralEnabled: true,
              ltv: '0.75',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '5578032.237176138122502577',
            },
            {
              token: {
                chainId: 42161,
                address: '0x0000000000000000000000000000000000000000',
                decimals: 18,
                symbol: 'ETH',
                name: 'Ethereum',
              },
              price: '2244.01978972',
              balance: '10340.220231199711325636',
              apy: '0.01435478420580403125',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.825',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '60336.252515494763460983',
            },
            {
              token: {
                chainId: 42161,
                address: '0x5979D7b546E38E414F7E9822514be443A4800529',
                decimals: 18,
                symbol: 'wstETH',
                name: 'Wrapped liquid staked Ether 2.0',
              },
              price: '2575.13844791',
              balance: '597.854708759269774618',
              apy: '0.00680150448981446132',
              usageAsCollateralEnabled: true,
              ltv: '0.7',
              liquidationThreshold: '0.8',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '31295.99616240731143495',
            },
            {
              token: {
                chainId: 42161,
                address: '0x912CE59144191C1204E64559FE8253a0e49E6548',
                decimals: 18,
                symbol: 'ARB',
                name: 'Arbitrum',
              },
              price: '1.12526332',
              balance: '546.580484888309644006',
              apy: '0.00698937805550445597',
              usageAsCollateralEnabled: true,
              ltv: '0.4',
              liquidationThreshold: '0.5',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '16948970.773345873611220716',
            },
          ],
          borrows: [
            {
              token: {
                chainId: 42161,
                address: '0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f',
                decimals: 8,
                symbol: 'WBTC',
                name: 'Wrapped BTC',
              },
              price: '42230.4416495',
              balances: ['67.14350092'],
              apys: ['0.09288334354334835704'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '669.64946723',
            },
            {
              token: {
                chainId: 42161,
                address: '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9',
                decimals: 6,
                symbol: 'USDT',
                name: 'Tether USD',
              },
              price: '0.99993522',
              balances: ['0'],
              apys: ['0.24556445414442673749'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '8524352.067416',
            },
            {
              token: {
                chainId: 42161,
                address: '0xFF970A61A04b1cA14834A43f5dE4533eBDDB5CC8',
                decimals: 6,
                symbol: 'USDC.e',
                name: 'USD Coin (Arb1)',
              },
              price: '1.00023692',
              balances: ['239995.369223'],
              apys: ['0.33344635059000808296'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '32608137.093197',
            },
            {
              token: {
                chainId: 42161,
                address: '0xDA10009cBd5D07dd0CeCc66161FC93D7c9000da1',
                decimals: 18,
                symbol: 'DAI',
                name: 'Dai Stablecoin',
              },
              price: '1.00005605',
              balances: ['0'],
              apys: ['0.22273058517580570194'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '4398878.503530040999772765',
            },
            {
              token: {
                chainId: 42161,
                address: '0x0000000000000000000000000000000000000000',
                decimals: 18,
                symbol: 'ETH',
                name: 'Ethereum',
              },
              price: '2244.01978972',
              balances: ['8636.117912147309336459'],
              apys: ['0.09927541344639658325'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '36342.118120508546382957',
            },
            {
              token: {
                chainId: 42161,
                address: '0x5979D7b546E38E414F7E9822514be443A4800529',
                decimals: 18,
                symbol: 'wstETH',
                name: 'Wrapped liquid staked Ether 2.0',
              },
              price: '2575.13844791',
              balances: ['0.00000661139690993'],
              apys: ['0.09438182165452173365'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '9408.58755496762596925',
            },
            {
              token: {
                chainId: 42161,
                address: '0x912CE59144191C1204E64559FE8253a0e49E6548',
                decimals: 18,
                symbol: 'ARB',
                name: 'Arbitrum',
              },
              price: '1.12526332',
              balances: ['0'],
              apys: ['0.09573188509401746726'],
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '5165060.848102571172733266',
            },
          ],
        },
      },
    ];

    testCases.forEach(({ chainId, account, blockTag, expected }) => {
      it(`${common.toNetworkId(chainId)} market`, async function () {
        const protocol = new LendingProtocol(chainId);
        protocol.setBlockTag(blockTag);
        const portfolio = await protocol.getPortfolio(account);
        expect(JSON.stringify(portfolio)).to.eq(JSON.stringify(expected));
      });
    });
  });
});
