import { LendingProtocol } from './lending-protocol';
import { arbitrumTokens, bnbTokens, mainnetTokens } from './tokens';
import * as common from '@protocolink/common';
import { expect } from 'chai';
import { removePortfolioDynamicFields } from 'src/protocol.utils';

describe('Test Radiant V2 LendingProtocol', function () {
  context('Test getPortfolio', function () {
    const testCases = [
      {
        chainId: common.ChainId.mainnet,
        account: '0xaF184b4cBc73A9Ca2F51c4a4d80eD67a2578E9F4',
        blockTag: 18797586,
        expected: {
          chainId: 1,
          protocolId: 'radiant-v2',
          marketId: 'mainnet',
          utilization: '0.88969606477533475173',
          healthRate: '1.17098530871127146488',
          totalSupplyUSD: '14802936.73275448119034789256139326',
          totalBorrowUSD: '10237301.2493721107694920432157276',
          supplies: [
            {
              token: mainnetTokens.USDT,
              price: '0.99961',
              balance: '2042222.619374',
              apy: '0.06265524668583752455',
              usageAsCollateralEnabled: true,
              ltv: '0.75',
              liquidationThreshold: '0.78',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '5831921.954657',
            },
            {
              token: mainnetTokens.USDC,
              price: '1.00027726',
              balance: '2222.533477',
              apy: '0.05652398165619130639',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.83',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '7894657.691217',
            },
            {
              token: mainnetTokens.ETH,
              price: '2242.39893',
              balance: '1103.573542689366688272',
              apy: '0.09945981063749235836',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.83',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '8206.144884311207768305',
            },
            {
              token: mainnetTokens.WBTC,
              price: '42140.09169',
              balance: '44.04572006',
              apy: '0.00563326889771342122',
              usageAsCollateralEnabled: true,
              ltv: '0.73',
              liquidationThreshold: '0.78',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '934.88422103',
            },
            {
              token: mainnetTokens.wstETH,
              price: '2579.31314226',
              balance: '1925.888117004630721355',
              apy: '0.00591641734410512259',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.83',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '13441.57315134992665744',
            },
            {
              token: mainnetTokens.sDAI,
              price: '1.04730616',
              balance: '3304536.314707822115945286',
              apy: '0.01627803260494082825',
              usageAsCollateralEnabled: true,
              ltv: '0.77',
              liquidationThreshold: '0.8',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '6354718.167766627896648403',
            },
            {
              token: mainnetTokens.rETH,
              price: '2450.18252296',
              balance: '0.087686639817703145',
              apy: '0.00933862214704218952',
              usageAsCollateralEnabled: true,
              ltv: '0.75',
              liquidationThreshold: '0.8',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '2210.188081321430521736',
            },
          ],
          borrows: [
            {
              token: mainnetTokens.USDT,
              price: '0.99961',
              balance: '2036566.319793',
              apy: '0.34885803310031651378',
              grossApy: '0.34885803310031651378',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '4743772.101778',
            },
            {
              token: mainnetTokens.USDC,
              price: '1.00027726',
              balance: '0',
              apy: '0.30895630613608824961',
              grossApy: '0.30895630613608824961',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '6451466.292218',
            },
            {
              token: mainnetTokens.ETH,
              price: '2242.39893',
              balance: '2116.653363798114056777',
              apy: '0.58286757852021725784',
              grossApy: '0.58286757852021725784',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '6781.209342806900264987',
            },
            {
              token: mainnetTokens.WBTC,
              price: '42140.09169',
              balance: '44.30477649',
              apy: '0.08556795486415211131',
              grossApy: '0.08556795486415211131',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '255.88862263',
            },
            {
              token: mainnetTokens.wstETH,
              price: '2579.31314226',
              balance: '0',
              apy: '0.08352546390718506892',
              grossApy: '0.05422546390718506892',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '3954.606921120925819826',
            },
            {
              token: mainnetTokens.sDAI,
              price: '1.04730616',
              balance: '1516405.29707996940880911',
              apy: '0.13549730800242546356',
              grossApy: '0.04019730800242546356',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '3230976.48548535361009371',
            },
            {
              token: mainnetTokens.rETH,
              price: '2450.18252296',
              balance: '0',
              apy: '0.1059438357261863594',
              grossApy: '0.0804438357261863594',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '816.842177473108670771',
            },
          ],
        },
      },
      {
        chainId: common.ChainId.bnb,
        account: '0xA15aEF397F9Dc9dE23C8e3Df8A289B21D4cA8fCD',
        blockTag: 38738990,
        expected: {
          chainId: 56,
          protocolId: 'radiant-v2',
          marketId: 'bnb',
          utilization: '1',
          healthRate: '1.03627738230590567017',
          totalSupplyUSD: '7113376.792946228696130057217',
          totalBorrowUSD: '5148266.94649033938170577969',
          supplies: [
            {
              token: bnbTokens.BTCB,
              price: '62129.33',
              balance: '114.493054935484124489',
              apy: '0.0018842556485471865',
              usageAsCollateralEnabled: true,
              ltv: '0.7',
              liquidationThreshold: '0.75',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '1084.102838189283152716',
            },
            {
              token: bnbTokens.USDT,
              price: '0.99970008',
              balance: '0',
              apy: '0.02809968318672521642',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '9582650.310842046916079284',
            },
            {
              token: bnbTokens.USDC,
              price: '1.000018',
              balance: '0',
              apy: '0.01251803618013794467',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '1311271.707413182088378375',
            },
            {
              token: bnbTokens.ETH,
              price: '2907.3027',
              balance: '0.000000000656295226',
              apy: '0.00677823374176924093',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.825',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '1118.474147562476422245',
            },
            {
              token: bnbTokens.BNB,
              price: '566.5998',
              balance: '0.000000263852488316',
              apy: '0.03966107938030156714',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.825',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '19635.216840550330009192',
            },
            {
              token: bnbTokens.wBETH,
              price: '3017.76764108',
              balance: '0',
              apy: '0.01238230639109096255',
              usageAsCollateralEnabled: true,
              ltv: '0.67',
              liquidationThreshold: '0.75',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '969.973021380570422044',
            },
          ],
          borrows: [
            {
              token: bnbTokens.BTCB,
              price: '62129.33',
              balance: '82.863712621564394493',
              apy: '0.02976988296074147581',
              grossApy: '0.02976988296074147581',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '278.272527950440262515',
            },
            {
              token: bnbTokens.USDT,
              price: '0.99970008',
              balance: '0',
              apy: '0.15507688545570079884',
              grossApy: '0.15507688545570079884',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '7368045.665148012727993507',
            },
            {
              token: bnbTokens.USDC,
              price: '1.000018',
              balance: '0',
              apy: '0.10141224907698186083',
              grossApy: '0.10141224907698186083',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '675538.856929831366139788',
            },
            {
              token: bnbTokens.ETH,
              price: '2907.3027',
              balance: '0',
              apy: '0.06186185971038594771',
              grossApy: '0.06186185971038594771',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '503.514650192829467621',
            },
            {
              token: bnbTokens.BNB,
              price: '566.5998',
              balance: '0',
              apy: '0.24293350514121534581',
              grossApy: '0.24293350514121534581',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '14047.112894395678975454',
            },
            {
              token: bnbTokens.wBETH,
              price: '3017.76764108',
              balance: '0',
              apy: '0.1292138860658574247',
              grossApy: '0.1292138860658574247',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '392.931959676069635801',
            },
          ],
        },
      },
      {
        chainId: common.ChainId.arbitrum,
        account: '0xBf891E7eFCC98A8239385D3172bA10AD593c7886',
        blockTag: 212204730,
        expected: {
          chainId: 42161,
          protocolId: 'radiant-v2',
          marketId: 'arbitrum',
          utilization: '0.53848398043013215877',
          healthRate: '1.99002702323255914318',
          totalSupplyUSD: '766543.31503734188390024910850188',
          totalBorrowUSD: '289055.6408428495936320769931429',
          supplies: [
            {
              token: arbitrumTokens.WBTC,
              price: '66088.36316',
              balance: '11.41605604',
              apy: '0.00196318897968311423',
              usageAsCollateralEnabled: true,
              ltv: '0.7',
              liquidationThreshold: '0.75',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '727.8512675',
            },
            {
              token: arbitrumTokens.USDT,
              price: '1.00011235',
              balance: '1918.537791',
              apy: '0.04805510947873574653',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '4186099.304021',
            },
            {
              token: arbitrumTokens['USDC.e'],
              price: '0.99997082',
              balance: '1408.334596',
              apy: '0.04061659415291205947',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '3531383.310976',
            },
            {
              token: arbitrumTokens.USDC,
              price: '0.99997082',
              balance: '2167.024645',
              apy: '0.04812526257349997641',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '12469578.409598',
            },
            {
              token: arbitrumTokens.DAI,
              price: '0.99999115',
              balance: '471.276398074218487047',
              apy: '0.0674084050935669473',
              usageAsCollateralEnabled: true,
              ltv: '0.75',
              liquidationThreshold: '0.85',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '237627.815157357173246156',
            },
            {
              token: arbitrumTokens.ETH,
              price: '3062.0843559',
              balance: '0.970658702062381248',
              apy: '0.01686310054431079716',
              usageAsCollateralEnabled: true,
              ltv: '0.8',
              liquidationThreshold: '0.825',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '12224.055002057462956113',
            },
            {
              token: arbitrumTokens.wstETH,
              price: '3579.24044119',
              balance: '0.266293774313130777',
              apy: '0.00571582468749767974',
              usageAsCollateralEnabled: true,
              ltv: '0.7',
              liquidationThreshold: '0.8',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '6800.672223595218250654',
            },
            {
              token: arbitrumTokens.ARB,
              price: '1.0172',
              balance: '2147.275717786117108881',
              apy: '0.00335813835725670002',
              usageAsCollateralEnabled: true,
              ltv: '0.4',
              liquidationThreshold: '0.5',
              isNotCollateral: false,
              supplyCap: '0',
              totalSupply: '7568516.518500651946107565',
            },
          ],
          borrows: [
            {
              token: arbitrumTokens.WBTC,
              price: '66088.36316',
              balance: '0',
              apy: '0.03039570992243704821',
              grossApy: '0.04863920534640730416',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '190.69833292',
            },
            {
              token: arbitrumTokens.USDT,
              price: '1.00011235',
              balance: '0',
              apy: '0.24355106587095911253',
              grossApy: '0.0818271308882687977',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '3605612.247555',
            },
            {
              token: arbitrumTokens['USDC.e'],
              price: '0.99997082',
              balance: '0',
              apy: '0.20447340550431672244',
              grossApy: '0.6390026190230117073',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '3022896.801863',
            },
            {
              token: arbitrumTokens.USDC,
              price: '0.99997082',
              balance: '286875.009064',
              apy: '0.15488676915066970035',
              grossApy: '0.07976328515371036879',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '10175340.647239',
            },
            {
              token: arbitrumTokens.DAI,
              price: '0.99999115',
              balance: '0',
              apy: '0.34757569716879936963',
              grossApy: '0.21715260913655817229',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '207864.237597719160921136',
            },
            {
              token: arbitrumTokens.ETH,
              price: '3062.0843559',
              balance: '0.714873444748942931',
              apy: '0.09575087895039513003',
              grossApy: '0.09722603980622196449',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '8942.127746735562230592',
            },
            {
              token: arbitrumTokens.wstETH,
              price: '3579.24044119',
              balance: '0',
              apy: '0.0862170217798655613',
              grossApy: '0.05355541450045965186',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '1874.761538931661643429',
            },
            {
              token: arbitrumTokens.ARB,
              price: '1.0172',
              balance: '0',
              apy: '0.0654819593607631197',
              grossApy: '0.05630361856540085611',
              borrowMin: '0',
              borrowCap: '0',
              totalBorrow: '1600167.203635506218057102',
            },
          ],
        },
      },
    ];

    testCases.forEach(({ chainId, account, blockTag, expected }) => {
      it(`${common.toNetworkId(chainId)} market`, async function () {
        const protocol = new LendingProtocol(chainId);
        protocol.setBlockTag(blockTag);

        const _portfolio = await protocol.getPortfolio(account);
        const portfolio = JSON.parse(JSON.stringify(_portfolio));

        removePortfolioDynamicFields(expected);
        removePortfolioDynamicFields(portfolio);

        expect(JSON.stringify(portfolio)).to.eq(JSON.stringify(expected));
      });
    });
  });
});
